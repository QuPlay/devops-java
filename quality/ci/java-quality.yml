# ==============================================================================
# Java Quality CI Template
#
# Usage: Copy this template to your project's .gitlab-ci.yml
#
# Source: https://github.com/QuPlay/DevOps-Java
# ==============================================================================

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "-q --batch-mode --errors --fail-at-end"
  SONAR_HOST_URL: "${SONAR_HOST_URL}"
  SONAR_TOKEN: "${SONAR_TOKEN}"

# ==============================================================================
# Cache Configuration
# ==============================================================================
.maven-cache:
  cache:
    key: "${CI_PROJECT_NAME}-maven"
    paths:
      - .m2/repository/
    policy: pull-push

# ==============================================================================
# Rule Templates
# ==============================================================================
.rules-mr:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

.rules-main:
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^(main|master|release|pre-release|develop)$/

.rules-all:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(main|master|release|pre-release|develop)$/

# ==============================================================================
# Stage: Build
# ==============================================================================
compile:
  stage: build
  extends:
    - .maven-cache
    - .rules-all
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Compiling ${CI_PROJECT_NAME}..."
    - mvn $MAVEN_CLI_OPTS compile
  allow_failure: false
  tags:
    - docker

# ==============================================================================
# Stage: Test
# ==============================================================================
unit-test:
  stage: test
  extends:
    - .maven-cache
    - .rules-all
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Running unit tests..."
    - mvn $MAVEN_CLI_OPTS test
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    reports:
      junit:
        - "**/target/surefire-reports/TEST-*.xml"
    paths:
      - "**/target/surefire-reports/"
    expire_in: 7 days
  allow_failure: false
  tags:
    - docker

# ==============================================================================
# Stage: Analysis
# ==============================================================================
sonarqube-check:
  stage: analysis
  extends:
    - .maven-cache
    - .rules-all
  image: maven:3.9-eclipse-temurin-17
  variables:
    GIT_DEPTH: "0"  # SonarQube needs full history for blame info
  script:
    - echo "Running SonarQube analysis..."
    - |
      mvn $MAVEN_CLI_OPTS sonar:sonar \
        -Dsonar.projectKey=${CI_PROJECT_NAME} \
        -Dsonar.projectName="${CI_PROJECT_NAME}" \
        -Dsonar.host.url=${SONAR_HOST_URL} \
        -Dsonar.login=${SONAR_TOKEN} \
        -Dsonar.qualitygate.wait=true \
        -Dsonar.gitlab.project_id=${CI_PROJECT_ID} \
        -Dsonar.gitlab.commit_sha=${CI_COMMIT_SHA} \
        -Dsonar.gitlab.ref_name=${CI_COMMIT_REF_NAME}
  allow_failure: false
  tags:
    - docker

# ==============================================================================
# Stage: Security (Optional)
# ==============================================================================
dependency-check:
  stage: analysis
  extends:
    - .maven-cache
    - .rules-main  # Only on main branches
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Running OWASP dependency check..."
    - mvn $MAVEN_CLI_OPTS org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=9
  artifacts:
    when: always
    paths:
      - "**/target/dependency-check-report.html"
    expire_in: 30 days
  allow_failure: true  # Warning only
  tags:
    - docker

# ==============================================================================
# Stage: Code Style Check (Mandatory - mirrors pre-commit hook)
# ==============================================================================
code-style:
  stage: build
  extends:
    - .rules-all
  image: alpine:latest
  before_script:
    - apk add --no-cache bash grep
  script:
    - |
      echo "Running code style checks (same as pre-commit hook)..."
      ERRORS=0

      # Check 1: Wildcard imports (BLOCKER)
      echo -n "  Checking wildcard imports... "
      WILDCARD=$(grep -rn "import .*\.\*;" --include="*.java" . 2>/dev/null | grep -v "/target/" || true)
      if [ -n "$WILDCARD" ]; then
          echo "FAILED"
          echo "Wildcard imports are forbidden:"
          echo "$WILDCARD"
          ERRORS=$((ERRORS + 1))
      else
          echo "OK"
      fi

      # Check 2: Debug statements (BLOCKER)
      echo -n "  Checking debug statements... "
      DEBUG=$(grep -rnE "(System\.(out|err)\.(print|println)|\.printStackTrace\(\))" --include="*.java" . 2>/dev/null | grep -v "/target/" || true)
      if [ -n "$DEBUG" ]; then
          echo "FAILED"
          echo "Debug statements found:"
          echo "$DEBUG"
          ERRORS=$((ERRORS + 1))
      else
          echo "OK"
      fi

      # Check 3: Sensitive data patterns (BLOCKER)
      echo -n "  Checking sensitive data... "
      SENSITIVE=$(grep -rnEi "(password|secret|token|apikey|api_key)\s*=\s*[\"'][^\"']+[\"']" --include="*.java" . 2>/dev/null | grep -v "/target/" | grep -v "// " || true)
      if [ -n "$SENSITIVE" ]; then
          echo "FAILED"
          echo "Potential hardcoded secrets:"
          echo "$SENSITIVE"
          ERRORS=$((ERRORS + 1))
      else
          echo "OK"
      fi

      # Final result
      if [ $ERRORS -gt 0 ]; then
          echo ""
          echo "Code style checks FAILED ($ERRORS error(s))"
          exit 1
      else
          echo ""
          echo "Code style checks PASSED"
      fi
  allow_failure: false  # Mandatory - blocks pipeline
  tags:
    - docker

# ==============================================================================
# Stage: Checkstyle (Optional)
# ==============================================================================
checkstyle:
  stage: analysis
  extends:
    - .maven-cache
    - .rules-mr  # Only on MR
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Running Checkstyle..."
    - mvn $MAVEN_CLI_OPTS checkstyle:check -Dcheckstyle.config.location=checkstyle.xml || true
  allow_failure: true  # Warning only
  tags:
    - docker

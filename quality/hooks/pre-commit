#!/bin/bash
# ==============================================================================
# Pre-commit Hook
#
# Purpose: Fast local checks before commit (can be bypassed with --no-verify)
# Source:  https://github.com/QuPlay/devops-java
# Update:  Run `mvn compile` to update hooks
# ==============================================================================
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}[DevOps]${NC} Running pre-commit checks..."

# Get staged Java files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.java$" || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}✓${NC} No Java files to check"
    exit 0
fi

ERRORS=0

# ==============================================================================
# Check 0: SonarQube for IDE Plugin (BLOCKER)
# ==============================================================================
echo -n "  Checking SonarQube for IDE... "

# 检查 .idea/sonarlint 目录是否存在（插件配置目录仍为 sonarlint）
SONAR_CONFIGURED=false

if [ -d ".idea/sonarlint" ] || [ -f ".idea/sonarlint.xml" ]; then
    SONAR_CONFIGURED=true
fi

# macOS: 检查用户级别的插件（目录名仍为 sonarlint）
if [ -d "$HOME/Library/Application Support/JetBrains" ]; then
    if ls "$HOME/Library/Application Support/JetBrains"/*/plugins/sonarlint* >/dev/null 2>&1; then
        SONAR_CONFIGURED=true
    fi
fi

# Linux: 检查用户级别的插件
if [ -d "$HOME/.local/share/JetBrains" ]; then
    if ls "$HOME/.local/share/JetBrains"/*/plugins/sonarlint* >/dev/null 2>&1; then
        SONAR_CONFIGURED=true
    fi
fi

# Windows (Git Bash): 检查用户级别的插件
if [ -d "$APPDATA/JetBrains" ]; then
    if ls "$APPDATA/JetBrains"/*/plugins/sonarlint* >/dev/null 2>&1; then
        SONAR_CONFIGURED=true
    fi
fi

if [ "$SONAR_CONFIGURED" = false ]; then
    echo -e "${RED}FAILED${NC}"
    echo -e "${RED}SonarQube for IDE plugin not detected!${NC}"
    echo -e "${YELLOW}Please install in IDEA:${NC}"
    echo -e "${YELLOW}  1. Settings → Plugins → Marketplace${NC}"
    echo -e "${YELLOW}  2. Search 'SonarQube for IDE' → Install${NC}"
    echo -e "${YELLOW}  3. Restart IDEA${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}OK${NC}"
fi

# ==============================================================================
# Check 1: Wildcard imports (BLOCKER)
# ==============================================================================
echo -n "  Checking wildcard imports... "
WILDCARD_IMPORTS=""
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        result=$(grep -n "import .*\.\*;" "$file" 2>/dev/null || true)
        if [ -n "$result" ]; then
            WILDCARD_IMPORTS="${WILDCARD_IMPORTS}\n  ${file}:\n${result}"
        fi
    fi
done

if [ -n "$WILDCARD_IMPORTS" ]; then
    echo -e "${RED}FAILED${NC}"
    echo -e "${RED}Wildcard imports are forbidden:${NC}${WILDCARD_IMPORTS}"
    echo -e "${YELLOW}Fix: Use explicit imports (IDEA: Settings → Editor → Code Style → Java → Imports → Class count to use import with '*' = 999)${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}OK${NC}"
fi

# ==============================================================================
# Check 2: Debug statements (BLOCKER)
# ==============================================================================
echo -n "  Checking debug statements... "
DEBUG_STATEMENTS=""
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        result=$(grep -nE "(System\.(out|err)\.(print|println)|\.printStackTrace\(\))" "$file" 2>/dev/null || true)
        if [ -n "$result" ]; then
            DEBUG_STATEMENTS="${DEBUG_STATEMENTS}\n  ${file}:\n${result}"
        fi
    fi
done

if [ -n "$DEBUG_STATEMENTS" ]; then
    echo -e "${RED}FAILED${NC}"
    echo -e "${RED}Debug statements found:${NC}${DEBUG_STATEMENTS}"
    echo -e "${YELLOW}Fix: Use slf4j logging (log.info/debug/error)${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}OK${NC}"
fi

# ==============================================================================
# Check 3: Sensitive data patterns (BLOCKER)
# ==============================================================================
echo -n "  Checking sensitive data... "
SENSITIVE_DATA=""
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Check for hardcoded passwords, tokens, secrets
        result=$(grep -nEi "(password|secret|token|apikey|api_key)\s*=\s*[\"'][^\"']+[\"']" "$file" 2>/dev/null | grep -v "// " || true)
        if [ -n "$result" ]; then
            SENSITIVE_DATA="${SENSITIVE_DATA}\n  ${file}:\n${result}"
        fi
    fi
done

if [ -n "$SENSITIVE_DATA" ]; then
    echo -e "${RED}FAILED${NC}"
    echo -e "${RED}Potential hardcoded secrets:${NC}${SENSITIVE_DATA}"
    echo -e "${YELLOW}Fix: Use environment variables or Nacos configuration${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}OK${NC}"
fi

# ==============================================================================
# Check 4: Null check style (WARNING)
# ==============================================================================
echo -n "  Checking null check style... "
NULL_CHECK_ISSUES=""
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Check for != null or == null (should use Objects.nonNull/isNull)
        result=$(grep -nE "\s(!=|==)\s*null" "$file" 2>/dev/null | head -5 || true)
        if [ -n "$result" ]; then
            NULL_CHECK_ISSUES="${NULL_CHECK_ISSUES}\n  ${file}:\n${result}"
        fi
    fi
done

if [ -n "$NULL_CHECK_ISSUES" ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo -e "${YELLOW}Use Objects.nonNull()/isNull() instead of != null / == null:${NC}${NULL_CHECK_ISSUES}"
    # Warning only, don't block
else
    echo -e "${GREEN}OK${NC}"
fi

# ==============================================================================
# Check 5: TODO/FIXME (WARNING)
# ==============================================================================
echo -n "  Checking TODO/FIXME... "
TODO_COUNT=0
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        count=$(grep -cE "(TODO|FIXME)" "$file" 2>/dev/null | tr -d '[:space:]' || echo "0")
        if [ -n "$count" ] && [ "$count" -eq "$count" ] 2>/dev/null; then
            TODO_COUNT=$((TODO_COUNT + count))
        fi
    fi
done

if [ "$TODO_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}WARNING (${TODO_COUNT} found)${NC}"
else
    echo -e "${GREEN}OK${NC}"
fi

# ==============================================================================
# Check 6: Large files (WARNING)
# ==============================================================================
echo -n "  Checking file sizes... "
LARGE_FILES=""
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        lines=$(wc -l < "$file" | tr -d ' ')
        if [ "$lines" -gt 1000 ]; then
            LARGE_FILES="${LARGE_FILES}\n  ${file}: ${lines} lines"
        fi
    fi
done

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo -e "${YELLOW}Files exceeding 1000 lines (consider refactoring):${NC}${LARGE_FILES}"
else
    echo -e "${GREEN}OK${NC}"
fi

# ==============================================================================
# Check 7: Claude AI Code Review (BLOCKER if score < MIN_SCORE)
# ==============================================================================

# Claude 审查配置
CLAUDE_REVIEW_ENABLED="${CLAUDE_REVIEW_ENABLED:-true}"
CLAUDE_MIN_SCORE="${CLAUDE_MIN_SCORE:-70}"
CLAUDE_TIMEOUT="${CLAUDE_TIMEOUT:-120}"
CLAUDE_MAX_LINES="${CLAUDE_MAX_LINES:-2000}"

run_claude_review() {
    echo -n "  Running Claude AI code review... "

    # 检查是否禁用
    if [ "$CLAUDE_REVIEW_ENABLED" = "false" ]; then
        echo -e "${YELLOW}SKIPPED (disabled)${NC}"
        return 0
    fi

    # 检查 claude 命令是否存在 (必须安装)
    if ! command -v claude &> /dev/null; then
        echo -e "${RED}FAILED (claude CLI not installed)${NC}"
        echo -e "${YELLOW}Install: npm install -g @anthropic-ai/claude-code${NC}"
        return 1
    fi

    # 获取变更内容
    local changes
    changes=$(git diff --cached --unified=3 -- $STAGED_FILES 2>/dev/null)

    if [ -z "$changes" ]; then
        echo -e "${GREEN}OK (no changes)${NC}"
        return 0
    fi

    # 检查变更行数
    local total_lines
    total_lines=$(echo "$changes" | wc -l | tr -d ' ')
    if [ "$total_lines" -gt "$CLAUDE_MAX_LINES" ]; then
        echo -e "${YELLOW}SKIPPED (${total_lines} lines > ${CLAUDE_MAX_LINES} limit)${NC}"
        return 0
    fi

    # 构建审查 prompt
    local prompt
    prompt=$(cat << 'PROMPT_EOF'
你是资深 Java 架构师，负责代码审查。请严格按照以下标准审查代码变更。

## 评分标准 (100分制，起始分100分)

### 致命问题 (BLOCKER - 存在即阻止提交，不打分)
1. 事务内同步调用外部服务/推送消息（应使用 TransactionSynchronization.afterCommit）
2. N+1 查询 - 循环内执行数据库查询（应批量预加载）
3. 并发安全 - 余额/库存计算存在竞态条件（应使用数据库原子操作）
4. SQL 注入 - 字符串拼接 SQL（应使用参数化查询）
5. 硬编码密码/密钥/Token
6. 关键业务路径未做 null 检查导致可能 NPE

### 严重问题 (BLOCKER - 存在即阻止提交，不打分)
1. 方法超过 120 行
2. 类超过 1000 行
3. 方法参数超过 8 个
4. 循环嵌套超过 3 层
5. 异常被吞掉（catch 块为空或仅打印日志）
6. 资源未关闭（流、连接等）

### 一般问题 (每项 -5 分)
1. 使用 != null 或 == null（应使用 Objects.nonNull/isNull）
2. 魔法数字/字符串未定义为常量
3. 缺少必要的参数校验
4. 方法职责不单一

### 轻微问题 (每项 -2 分)
1. 命名不规范
2. public 方法缺少 JavaDoc
3. 中文标点符号出现在注释中

## 输出格式 (必须严格遵守)

只输出以下 JSON，不要输出任何其他内容：

```json
{
  "score": <0-100整数>,
  "pass": <true或false>,
  "issues": [
    {"level": "critical|serious|general|minor", "file": "文件名", "line": "行号", "desc": "问题描述"}
  ],
  "summary": "一句话总结"
}
```

## 评判规则
1. 存在致命问题 (critical) 或严重问题 (serious)，pass 必须为 false，score 设为 0
2. 仅有一般/轻微问题时，正常打分，score < 70 则 pass 为 false
3. 没有问题时 issues 返回空数组，score 为 100

## 待审查的代码变更

PROMPT_EOF
)
    prompt="${prompt}

${changes}"

    # 执行 Claude 审查
    local result
    local exit_code=0

    # 使用超时命令
    if command -v gtimeout &> /dev/null; then
        result=$(echo "$prompt" | gtimeout "${CLAUDE_TIMEOUT}s" claude -p --output-format json 2>/dev/null) || exit_code=$?
    elif command -v timeout &> /dev/null; then
        result=$(echo "$prompt" | timeout "${CLAUDE_TIMEOUT}s" claude -p --output-format json 2>/dev/null) || exit_code=$?
    else
        result=$(echo "$prompt" | claude -p --output-format json 2>/dev/null) || exit_code=$?
    fi

    # 超时处理
    if [ $exit_code -eq 124 ]; then
        echo -e "${YELLOW}TIMEOUT (${CLAUDE_TIMEOUT}s)${NC}"
        return 0
    fi

    # 解析结果
    if [ -z "$result" ]; then
        echo -e "${YELLOW}SKIPPED (no response)${NC}"
        return 0
    fi

    # 提取 JSON - Claude CLI 输出格式: {"result": "```json\n{...}\n```", ...}
    local json

    # 方法1: 从 result 字段提取 (Claude CLI --output-format json)
    if echo "$result" | grep -q '"result"'; then
        # 提取 result 字段值，处理转义的换行和引号
        json=$(echo "$result" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    content = data.get('result', '')
    # 去掉 markdown 代码块
    content = content.replace('\`\`\`json', '').replace('\`\`\`', '').strip()
    print(content)
except:
    pass
" 2>/dev/null)
    fi

    # 方法2: 直接提取 JSON 对象
    if [ -z "$json" ]; then
        json=$(echo "$result" | sed -n '/^{/,/^}/p' | head -50)
    fi

    if [ -z "$json" ] || ! echo "$json" | grep -q '"score"'; then
        echo -e "${YELLOW}SKIPPED (parse error)${NC}"
        return 0
    fi

    # 提取评分和通过状态
    local score
    local pass
    local summary

    score=$(echo "$json" | grep -o '"score"[[:space:]]*:[[:space:]]*[0-9]*' | grep -o '[0-9]*' | head -1)
    pass=$(echo "$json" | grep -o '"pass"[[:space:]]*:[[:space:]]*[a-z]*' | grep -o 'true\|false' | head -1)
    summary=$(echo "$json" | grep -o '"summary"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/"summary"[[:space:]]*:[[:space:]]*"//' | sed 's/"$//')

    # 检查是否有致命或严重问题 (BLOCKER - 直接阻止，不看分数)
    local has_critical
    local has_serious
    has_critical=$(echo "$json" | grep -o '"level"[[:space:]]*:[[:space:]]*"critical"' | head -1)
    has_serious=$(echo "$json" | grep -o '"level"[[:space:]]*:[[:space:]]*"serious"' | head -1)

    if [ -z "$score" ]; then
        echo -e "${YELLOW}SKIPPED (no score)${NC}"
        return 0
    fi

    # 清除之前的 "Running..." 行，开始美观输出
    echo ""
    echo ""

    # 输出 JSON 详情
    echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    # 格式化输出 JSON（保留中文，不转 Unicode）
    if command -v python3 &> /dev/null; then
        echo "$json" | python3 -c "import sys,json; print(json.dumps(json.load(sys.stdin),indent=2,ensure_ascii=False))" 2>/dev/null || echo "$json"
    else
        echo "$json"
    fi
    echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # 判断结果
    local review_passed=true
    local status_text="PASSED"
    local status_color="${GREEN}"

    if [ -n "$has_critical" ] || [ -n "$has_serious" ]; then
        review_passed=false
        status_text="BLOCKED"
        status_color="${RED}"
    elif [ "$pass" = "false" ] || [ "$score" -lt "$CLAUDE_MIN_SCORE" ]; then
        review_passed=false
        status_text="FAILED"
        status_color="${RED}"
    fi

    # 输出结果框
    echo -e "  ${status_color}╔═══════════════════════════════════════════════════════════╗${NC}"
    printf "  ${status_color}║%s${NC}\n" "$(printf '%*s' -59 "CODE REVIEW ${status_text}" | sed 's/^/                    /')"
    echo -e "  ${status_color}╠═══════════════════════════════════════════════════════════╣${NC}"
    printf "  ${status_color}║  Score: %-3s / 100                                        ║${NC}\n" "$score"
    echo -e "  ${status_color}╠═══════════════════════════════════════════════════════════╣${NC}"

    # 输出 summary（可能需要截断）
    if [ -n "$summary" ]; then
        # 截断过长的 summary
        local display_summary="$summary"
        if [ ${#display_summary} -gt 55 ]; then
            display_summary="${display_summary:0:52}..."
        fi
        printf "  ${status_color}║  %-57s║${NC}\n" "$display_summary"
    else
        printf "  ${status_color}║  %-57s║${NC}\n" "No issues found"
    fi
    echo -e "  ${status_color}╚═══════════════════════════════════════════════════════════╝${NC}"
    echo ""

    # 返回结果
    if [ "$review_passed" = false ]; then
        return 1
    else
        return 0
    fi
}

# 执行 Claude 审查
if ! run_claude_review; then
    ERRORS=$((ERRORS + 1))
fi

# ==============================================================================
# Final Result
# ==============================================================================
echo ""
if [ ${ERRORS:-0} -gt 0 ]; then
    echo -e "${RED}[DevOps] Pre-commit checks FAILED (${ERRORS} error(s))${NC}"
    echo -e "${YELLOW}To bypass (not recommended): git commit --no-verify${NC}"
    exit 1
else
    echo -e "${GREEN}[DevOps] Pre-commit checks PASSED${NC}"
    exit 0
fi
